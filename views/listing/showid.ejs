<% layout ("/layouts/boilerplate.ejs") -%>
<body>

  <div class="row">
<div class="col-10 offset-2">

  <h2> <b><%= idInfo.title %></b></h2>
  <div class="col-md-8 offset-2">
    <div >

    <img src="<%= idInfo.image.url%>" alt="listing image" class="card-img-top show-img " style="height: 50vh;">
  </div>

    <div class="card-body">
      <p class="card-text">
        <b><%= idInfo.title %></b>
        <br>
        <i><%= idInfo.owner.username%></i> 
        <br>
        <%= idInfo.description %>
      <br>
      &#8377;<%= idInfo.price %>/night
      <br>
      <%= idInfo.location %>
      <br>
      <%= idInfo.country %>
     

      </p>
    </div>
  </div>

 <!-- .toLocalString("en-in") -->
 <% if (currentUser && currentUser._id.equals(idInfo.owner._id)){%>
  <div class="col-md-8 offset-2">
    <form action="/listing/<%=idInfo._id%>/edit">
      <button class="btn btn-dark mt-3">Edit</button>
    </form>
    
    <form  method="get" action="/listing/<%=idInfo._id%>/delete" >
      <button class="btn btn-danger mt-3">delete</button>
    </form>
  </div>
 <%}%>
  
 
</div>
</div>
<hr>
<% if(currentUser){%>
<div class="col-10 offset-2">
  <h4>Leave a Review</h4>
  <form method="post"  action="/listing/      <%=idInfo._id%>/review" class="mb-3 col-md-8 offset-2"  novalidate class="needs-validation">
  <!-- <div class="mb-3 mt-3">
    <label for="rating" class="form-label">Rating: </label>
    <input type="range"min="1" max="5" name="review[rating]" id="rating" class="form-range">
  </div> -->

  <fieldset class="starability-slot ">
    <legend>First rating:</legend>
    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
    <label for="first-rate1" title="Terrible">1 star</label>
    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
    <label for="first-rate2" title="Not good">2 stars</label>
    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
    <label for="first-rate3" title="Average">3 stars</label>
    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
    <label for="first-rate4" title="Very good">4 stars</label>
    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
    <label for="first-rate5" title="Amazing">5 stars</label>
  </fieldset>


  <div class="mb-3">
    <label for="comment"class="form-label"  >Comment:</label><br>
    <textarea name="review[comment]"
       id="comment" cols="30" rows="5"
       class="form-control" required></textarea>
    <div class="invalid-feedback">
      Please give a proper Feedback!!
    </div>
  </div>
  <button type="submit" class="btn btn-dark mb-3">Submit</button>
</form>
<hr>
<%}%>
</div>

<div class="col-10 offset-2">
<% if(idInfo.reviews.length > 0){%> 
<h4>All Reviews</h4>
<div class="row col-md-8 offset-2">
<%for(review of idInfo.reviews){%>
  <div class="card mb-1" style="height: 7%; width:10% ;">
    <div class="card-body">
      <h5 class="card-title"><%=review.auther?.username || "unknown user" %></h5>
      <p class="starability-result" data-rating=<%=review.rating%>></p>
      <p class="card-text"><%=review.comment%></p>
    </div>

    <form method="post" action="/listing/<%=idInfo._id%>/review/<%=review._id%>?_method=DELETE">
      <button class="btn btn-sm btn-dark mb-3">Delete</button>
    </form>
  </div>
<%}%>
</div>
<%}%>
</div>

<div class="col-10 offset-2">
  <h4>Location:</h4>
<div id="map"  class="col-sm-10 col-md-8 offset-2"  style="height: 50vh; "></div><br>
</div>

</body>

<script>
  // // create map centered at Burhanpur
  // const map = L.map('map').setView([21.186,76.051],13);
  // // load OpenStreetMap tiles
  // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  //     maxZoom:18,
  //     attribution:'OpenStreetMap contributors'
  // }).addTo(map);
  // // // add single marker for burhanpur
  // // L.marker([21.186,76.051]).addTo(map).bindPopup("Burhanpur<br> This is my hometown!").openPopup();

  const locationText = "<%= idInfo.location%>,<%=idInfo.country%>";

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${locationText}`)
  .then(res => res.json())
  .then(data=>{
    if(data.length > 0){
      const lat = data[0].lat;
      const lon = data[0].lon;
      
      const map = L.map('map').setView([lat,lon],13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom : 18,
        attribution:'OpenStreetMap contributors'
      }).addTo(map);
       
      L.marker([lat,lon]).addTo(map).bindPopup(locationText).openPopup();
    }else{
      alert("X location not found.");
     }
  });

</script>